<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agent Terminal</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
      background: #1a1a2e;
      color: #e2e8f0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      font-size: 13px;
      line-height: 1.5;
    }

    #status-bar {
      background: #0f0f1e;
      padding: 6px 12px;
      font-size: 12px;
      border-bottom: 1px solid #2d2d4a;
      color: #94a3b8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 28px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #status-bar .status-item {
      background: #252540;
      padding: 2px 8px;
      border-radius: 3px;
      color: #a5b4fc;
    }
    #status-bar .status-item.alert {
      color: #fbbf24;
    }
    #status-bar .status-item.error {
      color: #f87171;
    }
    #status-bar .connected {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #4ade80;
      display: inline-block;
    }
    #status-bar .disconnected {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #f87171;
      display: inline-block;
    }
    #shell-id {
      color: #6366f1;
      font-weight: bold;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .msg {
      white-space: pre-wrap;
      word-break: break-word;
      padding: 2px 0;
    }
    .msg-system {
      color: #64748b;
      font-style: italic;
    }
    .msg-push {
      color: #a5b4fc;
    }
    .msg-push .tool-name {
      color: #6366f1;
      font-weight: bold;
    }
    .msg-command {
      color: #94a3b8;
    }
    .msg-command::before {
      content: '> ';
      color: #4ade80;
    }
    .msg-output {
      color: #e2e8f0;
      padding-left: 12px;
      border-left: 2px solid #2d2d4a;
    }
    .msg-error {
      color: #f87171;
    }
    .msg-dm {
      color: #34d399;
    }
    .msg-dm .from-name {
      font-weight: bold;
      color: #10b981;
    }

    /* Board view */
    .board {
      display: flex;
      gap: 8px;
      padding: 8px 0;
      overflow-x: auto;
      min-height: 80px;
    }
    .board-col {
      min-width: 140px;
      max-width: 200px;
      background: #252540;
      border-radius: 4px;
      padding: 8px;
      flex-shrink: 0;
    }
    .board-col-title {
      font-size: 10px;
      color: #6366f1;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      font-weight: bold;
    }
    .board-item {
      font-size: 12px;
      padding: 4px 6px;
      background: #1a1a2e;
      border-radius: 3px;
      margin-bottom: 4px;
      cursor: pointer;
      border-left: 3px solid transparent;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .board-item:hover {
      background: #2d2d4a;
    }
    .board-item.claimed {
      border-left-color: #4ade80;
    }
    .board-item .item-id {
      color: #64748b;
      margin-right: 4px;
    }

    #input-area {
      display: flex;
      padding: 8px 12px;
      border-top: 1px solid #2d2d4a;
      background: #0f0f1e;
      gap: 8px;
    }
    #input {
      flex: 1;
      background: #252540;
      border: 1px solid #2d2d4a;
      color: #e2e8f0;
      padding: 6px 10px;
      font-family: inherit;
      font-size: 13px;
      border-radius: 4px;
      outline: none;
    }
    #input:focus {
      border-color: #6366f1;
    }
    #input::placeholder {
      color: #475569;
    }
  </style>
</head>
<body>
  <div id="status-bar">
    <span class="disconnected" id="conn-indicator"></span>
    <span id="shell-id"></span>
    <span id="status-text">connecting...</span>
  </div>
  <div id="messages">
    <div class="msg msg-system" id="welcome-msg"></div>
  </div>
  <div id="input-area">
    <input id="input" type="text" placeholder="tool command..." autofocus>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search)
    const PORT = params.get('port') || '8700'
    const MODE = params.get('mode') || 'human'
    const BASE_URL = `http://localhost:${PORT}`
    const WS_URL = `ws://localhost:${PORT}/ws/terminal`

    const messagesEl = document.getElementById('messages')
    const inputEl = document.getElementById('input')
    const statusTextEl = document.getElementById('status-text')
    const connIndicator = document.getElementById('conn-indicator')
    const shellIdEl = document.getElementById('shell-id')
    let ws = null
    let shellId = null
    let commandHistory = []
    let historyIndex = -1

    // ==========================================
    // WebSocket Connection
    // ==========================================

    function connect() {
      ws = new WebSocket(WS_URL)

      ws.onopen = () => {
        connIndicator.className = 'connected'
        if (!shellId) statusTextEl.textContent = 'connected'
      }

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data)
          switch (msg.type) {
            case 'identity':
              shellId = msg.shellId
              shellIdEl.textContent = shellId
              // Auto-name based on mode
              if (MODE === 'agent') {
                fetch(`${BASE_URL}/terminal/command`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ command: `whoami agent`, shellId }),
                })
              }
              break
            case 'status':
              renderStatusLine(msg.line)
              break
            case 'push':
              addMessage('push', `${msg.tool}: ${msg.text}`, msg.tool)
              scrollToBottom()
              break
            case 'message':
              addMessage('dm', `${msg.from}: ${msg.text}`, msg.from)
              scrollToBottom()
              break
            case 'shell-joined':
              if (msg.shellId !== shellId) {
                addMessage('system', `${msg.shellId} joined`)
                scrollToBottom()
              }
              break
            case 'shell-left':
              addMessage('system', `${msg.name || msg.shellId} left`)
              scrollToBottom()
              break
            case 'shell-renamed':
              if (msg.shellId === shellId) {
                shellIdEl.textContent = msg.name || shellId
              }
              addMessage('system', `${msg.shellId} â†’ ${msg.name}`)
              scrollToBottom()
              break
            case 'task-changed':
              addMessage('system', `tasks updated by ${msg.by}`)
              scrollToBottom()
              break
          }
        } catch {}
      }

      ws.onclose = () => {
        connIndicator.className = 'disconnected'
        statusTextEl.textContent = 'disconnected'
        setTimeout(connect, 2000)
      }

      ws.onerror = () => {
        ws.close()
      }
    }

    // ==========================================
    // Status Line Rendering
    // ==========================================

    function renderStatusLine(line) {
      if (!line) {
        statusTextEl.textContent = 'idle'
        return
      }
      const items = line.match(/\[([^\]]+)\]/g) || []
      let html = ''
      for (const item of items) {
        const text = item.slice(1, -1)
        let cls = 'status-item'
        if (/fail|error/i.test(text)) cls += ' error'
        else if (/warn|blocked/i.test(text)) cls += ' alert'
        html += `<span class="${cls}">${escapeHtml(text)}</span> `
      }
      statusTextEl.innerHTML = html || 'idle'
    }

    // ==========================================
    // Board View Rendering
    // ==========================================

    function renderBoard(boardData) {
      const container = document.createElement('div')
      container.className = 'board'

      const columnOrder = ['icebox', 'queued', 'in_progress', 'blocked', 'review', 'done']
      for (const col of columnOrder) {
        const items = boardData.columns[col]
        if (!items || items.length === 0) continue

        const colEl = document.createElement('div')
        colEl.className = 'board-col'

        const titleEl = document.createElement('div')
        titleEl.className = 'board-col-title'
        titleEl.textContent = col.replace('_', ' ')
        colEl.appendChild(titleEl)

        for (const item of items) {
          const itemEl = document.createElement('div')
          itemEl.className = 'board-item' + (item.claimed ? ' claimed' : '')
          itemEl.innerHTML = `<span class="item-id">#${item.id}</span>${escapeHtml(item.title)}`
          itemEl.title = item.claimed ? `claimed: ${item.claimed}` : item.title
          itemEl.addEventListener('click', () => {
            inputEl.value = `tasks detail ${item.id}`
            inputEl.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }))
          })
          colEl.appendChild(itemEl)
        }

        container.appendChild(colEl)
      }

      return container
    }

    // ==========================================
    // Command Input
    // ==========================================

    inputEl.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter' && inputEl.value.trim()) {
        const command = inputEl.value.trim()
        commandHistory.push(command)
        historyIndex = commandHistory.length
        inputEl.value = ''

        addMessage('command', command)
        scrollToBottom()

        try {
          const resp = await fetch(`${BASE_URL}/terminal/command`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command, shellId }),
          })
          const output = await resp.text()

          // Check if output is a board JSON
          if (output.startsWith('{"type":"board"')) {
            try {
              const boardData = JSON.parse(output)
              const boardEl = renderBoard(boardData)
              messagesEl.appendChild(boardEl)
            } catch {
              addMessage('output', output)
            }
          } else if (output.startsWith('error:')) {
            addMessage('error', output)
          } else {
            addMessage('output', output)
          }
        } catch (err) {
          addMessage('error', `connection error: ${err.message}`)
        }
        scrollToBottom()
      }

      if (e.key === 'ArrowUp') {
        e.preventDefault()
        if (historyIndex > 0) {
          historyIndex--
          inputEl.value = commandHistory[historyIndex]
        }
      }
      if (e.key === 'ArrowDown') {
        e.preventDefault()
        if (historyIndex < commandHistory.length - 1) {
          historyIndex++
          inputEl.value = commandHistory[historyIndex]
        } else {
          historyIndex = commandHistory.length
          inputEl.value = ''
        }
      }
    })

    // ==========================================
    // Message Display
    // ==========================================

    function addMessage(type, text, extra) {
      const div = document.createElement('div')
      div.className = `msg msg-${type}`
      if (type === 'push' && extra) {
        div.innerHTML = `<span class="tool-name">${escapeHtml(extra)}</span> ${escapeHtml(text.replace(extra + ': ', ''))}`
      } else if (type === 'dm' && extra) {
        div.innerHTML = `<span class="from-name">@${escapeHtml(extra)}</span> ${escapeHtml(text.replace(extra + ': ', ''))}`
      } else {
        div.textContent = text
      }
      messagesEl.appendChild(div)

      while (messagesEl.children.length > 500) {
        messagesEl.removeChild(messagesEl.firstChild)
      }
    }

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    }

    // ==========================================
    // Init
    // ==========================================

    // Set welcome message based on mode
    const welcomeEl = document.getElementById('welcome-msg')
    if (MODE === 'agent') {
      welcomeEl.textContent = 'Agent terminal. Awaiting commands.'
      document.title = 'Agent Terminal'
    } else {
      welcomeEl.textContent = 'Terminal ready. Type "tasks" for the board, "who" for shells, or a tool command.'
      document.title = 'Terminal'
    }

    // Listen for rename from parent (address bar)
    window.addEventListener('message', (event) => {
      if (event.data?.type === 'rename' && event.data.name && shellId) {
        fetch(`${BASE_URL}/terminal/command`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: `whoami ${event.data.name}`, shellId }),
        }).then(() => {
          shellIdEl.textContent = event.data.name
        })
      }
    })

    fetch(`${BASE_URL}/terminal/status`)
      .then(r => r.text())
      .then(line => renderStatusLine(line))
      .catch(() => {})

    connect()
  </script>
</body>
</html>
